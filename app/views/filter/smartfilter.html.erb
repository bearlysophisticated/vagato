<h1>Intelligens keresés</h1>

<div class="well">

  <%= simple_form_for @filter, url: {controller: 'filter', action: 'filter'} do |f| %>
      <%= f.hidden_field :filter, :value => :smart %>
      <%= hidden_field_tag :base_url, '/smartfilter' %>

      <div class="row">

        <div class='col-md-4'>
          <div class="form-group">
            <div class='input-group'>
              <%= text_field_tag :city, params[:city], class: 'form-control', placeholder: 'Város' %>
              <span class="input-group-addon"><i class="fa fa-map-marker"></i></span>
            </div>
          </div>
        </div>

        <div class='col-md-3'>
          <div class="form-group">
            <div class='input-group'>
              <%= text_field_tag :start_date, params[:start_date], class: 'form-control', required: true, placeholder: 'Érkezés' %>
              <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
            </div>
          </div>
        </div>

        <div class='col-md-3'>
          <div class="form-group">
            <div class='input-group'>
              <%= text_field_tag :end_date, params[:end_date], class: 'form-control', required: true, placeholder: 'Távozás' %>
              <span class="input-group-addon"><i class="fa fa-calendar"></i></span>
            </div>
          </div>
        </div>

        <div class='col-md-2'>
          <div class="form-group">
            <div class='input-group'>
              <%= number_field_tag :guests, params[:guests], class: 'form-control', required: true, placeholder: 'Vendégek' %>
              <span class="input-group-addon"><i class="fa fa-users"></i></span>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
          <div class="panel panel-default">
            <div class="panel-heading">Felszereltség</div>
            <div class="panel-body">
              <div class="checkbox">
                <%= f.collection_check_boxes(:equipment_ids, Equipment.all, :id, :name, {:item_wrapper_class => 'checkbox_container'}) %>
              </div>
            </div>
          </div>
        </div>

        <div class="col-md-6">
          <div class="panel panel-default">
            <div class="panel-heading">Szolgáltatások</div>
            <div class="panel-body">
              <div class="checkbox">
                <%= f.collection_check_boxes(:serviice_ids, Serviice.all, :id, :name, {:item_wrapper_class => 'checkbox_container'}) %>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="row">
        <div class="col-md-6">
            <div class="panel panel-default">
              <div class="panel-heading">Keresési szempontok</div>
              <div class="panel-body">
                <div class="row">
                  <div class="col-md-8">
                    <strong>A szobák legyenek minél olcsóbbak:</strong>
                  </div>
                  <div class="col-md-4">
                    <%= check_box_tag :cheap, 1, params.has_key?(:cheap) || (!params.has_key?(:cheap) && !params.has_key?(:close)), :class => 'checkbox', 'data-on-text' => 'IGEN', 'data-off-text' => 'NEM','data-on-color' => 'success' %>
                  </div>
                </div><br />
                <div class="row">
                  <div class="col-md-8">
                    <strong>A szobák legyenek minél közelebb egymáshoz:</strong>
                  </div>
                  <div class="col-md-4">
                    <%= check_box_tag :close, 1, params.has_key?(:close), :class => 'checkbox', 'data-on-text' => 'IGEN', 'data-off-text' => 'NEM','data-on-color' => 'success' %>
                  </div>
                </div>
              </div>
            </div>
        </div>
        <div class="col-md-6">
          <div class="panel panel-default">
            <div class="panel-heading">Szobatípus</div>
            <div class="panel-body">
              <label class="checkbox-inline">
                <%= check_box_tag :one_bed, 1, true, :class => 'checkbox' %> Egyágyas
              </label>
              <label class="checkbox-inline">
                <%= check_box_tag :two_bed, 1, true, :class => 'checkbox' %> Kétágyas
              </label>
              <label class="checkbox-inline">
                <%= check_box_tag :three_bed, 1, true, :class => 'checkbox' %> Háromágyas
              </label>
              <label class="checkbox-inline">
                <%= check_box_tag :four_or_more_bed, 1, true, :class => 'checkbox' %> Négy vagy több ágyas
              </label>
            </div>
          </div>
        </div>
      </div>

      <div class="row center">
        <%= button_tag 'Keresés' , class: 'btn btn-primary', style: 'width: 200px' %>
      </div>
  <% end %>

</div>

<% if @rooms.size > 0 %>
    <br />
    <h2>Találatok <small><%= @rooms.size %> szoba (<%= @execution_time %> másodperc)</small></h2>

    <div align="right">
      <%= form_tag ({controller: 'cart', action: 'add_from_smartfilter'}) do %>
          <%= hidden_field_tag :start_date, params[:start_date] %>
          <%= hidden_field_tag :end_date, params[:end_date] %>
          <%= hidden_field_tag :rooms, @rooms.map { |r| r.id } %>
          <button class="btn btn-primary">Kosárba <i class="fa fa-shopping-cart"></i></button>
      <% end %>
    </div><br />
<% end %>

<div class="rooms row">
  <% @rooms.each do |room| %>
      <div class="col-xs-6 col-sm-4 col-md-4 col-lg-3">
        <%= render 'rooms/thumbnail', :room => room %>
      </div>
  <% end %>
</div><br />

<% if params.has_key?(:filter) && @rooms.size > 0 %>
    <div>
        <div id="smartfilter-map"></div>
    </div>

    <script src="//maps.google.com/maps/api/js?v=3.13&amp;sensor=false&amp;libraries=geometry" type="text/javascript"></script>
    <script src='//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js' type='text/javascript'></script>
    <script>
        handler = Gmaps.build('Google');
        handler.buildMap({
                    provider: {
                        disableDefaultUI: true,
                        mapTypeId: google.maps.MapTypeId.ROADMAP
                    },
                    internal: {
                        id: 'smartfilter-map'
                    }
                },
                function(){
                    markers = handler.addMarkers(<%=raw @map_hash.to_json %>);
                    handler.bounds.extendWith(markers);
                    handler.fitMapToBounds();
                    handler.getMap().setZoom(12);
                }
        );
    </script>
<% end %>


<script type="application/javascript">
    var ready = function() {
        initialize_switches();
        fill_inputs();
    };

    $(document).ready(ready);
    $(document).on('page:load', ready);

    function initialize_switches(){
        $("#cheap").bootstrapSwitch();
        $("#close").bootstrapSwitch();
    }

    function fill_inputs() {
        fill_equipments();
        fill_serviices();
        fill_capacity_options();
    }

    /*function fill_dates() {
        <% if params.has_key?(:start_date) && params.has_key?(:end_date) %>
            $('#start_date').val("<%= params[:start_date] %>");
            $('#end_date').val("<%= params[:end_date] %>");
        <% end %>
    }

    function fill_city() {
        <% if params.has_key? :city %>
            $('#city').val("<%= params[:city] %>");
        <% end %>
    }

    function fill_guests() {
        <% if params.has_key? :guests %>
            $('#guests').val("<%= params[:guests] %>");
        <% end %>
    }*/

    function fill_equipments() {
        <% if params.has_key? :equipment_ids
         params[:equipment_ids].split(',').each do |e| %>
            $('#filter_equipment_ids_<%= e %>').prop('checked', true);
        <% end end %>
    }

    function fill_serviices() {
        <% if params.has_key? :serviice_ids
         params[:serviice_ids].split(',').each do |s| %>
            $('#filter_serviice_ids_<%= s %>').prop('checked', true);
        <% end end %>
    }

    /*function fill_options() {
        <% unless params.has_key? :cheap %>
            $('#cheap').bootstrapSwitch('toogleState');
        <% end %>
        <% if params.has_key? :close %>
            $('#close').bootstrapSwitch('toogleState');
        <% end %>
    }*/

    function fill_capacity_options() {
        <% if (params.has_key?(:one_bed) || params.has_key?(:two_bed) || params.has_key?(:three_bed) || params.has_key?(:four_or_more_bed)) == false %>
            $('#one_bed').attr('checked', true);
            $('#two_bed').attr('checked', true);
            $('#three_bed').attr('checked', true);
            $('#four_or_more_bed').attr('checked', true);
        <% else %>
            <% unless params.has_key? :one_bed %>
                $('#one_bed').removeAttr('checked');
            <% end %>
            <% unless params.has_key? :two_bed %>
                $('#two_bed').removeAttr('checked');
            <% end %>
            <% unless params.has_key? :three_bed %>
                $('#three_bed').removeAttr('checked');
            <% end %>
            <% unless params.has_key? :four_or_more_bed %>
                $('#four_or_more_bed').removeAttr('checked');
            <% end %>
        <% end %>
    }

    var setupFilterDatePickers = function() {
        var start_date = $('#start_date');
        var end_date = $('#end_date');

        start_date.datetimepicker({
            locale: "hu",
            calendarWeeks: true,
            format: "YYYY.MM.DD"
        });
        start_date.data("DateTimePicker").setMinDate(new Date());

        end_date.datetimepicker({
            locale: "hu",
            calendarWeeks: true,
            format: "YYYY.MM.DD"
        });

        start_date.on("dp.change", function (e) {
            end_date.data("DateTimePicker").setMinDate(e.date.add(1, 'days'));
            if(end_date.data("DateTimePicker").date <= e.date){
                end_date.data("DateTimePicker").setDate(e.date);
            }
            setNightsInput();
        });
    };

    var ready = function() {
        setupFilterDatePickers();
    };

    $(document).ready(ready);
    $(document).on('page:load', ready);
</script>